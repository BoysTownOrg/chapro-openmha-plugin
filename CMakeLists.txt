cmake_minimum_required(VERSION 3.14 FATAL_ERROR)
project(chapro-openMHA-plugin)
option(ENABLE_TESTS "Enable tests" OFF)
if (${ENABLE_TESTS})
    enable_testing()
endif()
set(CMAKE_SKIP_INSTALL_ALL_DEPENDENCY true)

add_subdirectory(googletest EXCLUDE_FROM_ALL)
add_subdirectory(GSL EXCLUDE_FROM_ALL)

set(PRIVATE_INSTALL_PREFIX ${CMAKE_BINARY_DIR}/install)
set(PRIVATE_INSTALL_LIB ${PRIVATE_INSTALL_PREFIX}/lib)
set(PRIVATE_INSTALL_INCLUDE ${PRIVATE_INSTALL_PREFIX}/include)
file(MAKE_DIRECTORY ${PRIVATE_INSTALL_PREFIX})
file(MAKE_DIRECTORY ${PRIVATE_INSTALL_LIB})
file(MAKE_DIRECTORY ${PRIVATE_INSTALL_INCLUDE})

include(ExternalProject)

ExternalProject_Add(
    project_openMHA
    GIT_REPOSITORY  https://github.com/HoerTech-gGmbH/openMHA
    BUILD_IN_SOURCE TRUE
    CONFIGURE_COMMAND ./configure
    BUILD_COMMAND make DYNAMIC_LIB_EXT=${CMAKE_SHARED_LIBRARY_SUFFIX} mha/libmha
    INSTALL_COMMAND make PREFIX=${PRIVATE_INSTALL_PREFIX} install
)

add_library(openMHA SHARED IMPORTED)
set_target_properties(openMHA PROPERTIES 
    IMPORTED_LOCATION ${PRIVATE_INSTALL_PREFIX}/lib/libopenMHA${CMAKE_SHARED_LIBRARY_SUFFIX})

ExternalProject_Get_Property(project_openMHA SOURCE_DIR)
include_directories(${SOURCE_DIR}/mha/libmha/src)

ExternalProject_Add(
    project_chapro
    GIT_REPOSITORY https://github.com/boystownorg/chapro
    BUILD_IN_SOURCE TRUE
    CONFIGURE_COMMAND chmod +x configure && ./configure
    BUILD_COMMAND make libchapro.a
    INSTALL_COMMAND make 
        INCDIR=${PRIVATE_INSTALL_INCLUDE}
        LIBDIR=${PRIVATE_INSTALL_LIB} install
)

add_library(chapro STATIC IMPORTED)
set_target_properties(chapro PROPERTIES 
    IMPORTED_LOCATION ${PRIVATE_INSTALL_LIB}/libchapro.a)
target_include_directories(chapro INTERFACE ${PRIVATE_INSTALL_INCLUDE})

add_subdirectory(chapro-openmha-plugin)
